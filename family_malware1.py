import vt
import hashlib
import os
import time
from datetime import datetime, timezone, timedelta
from typing import Union

# --- 1. ì„¤ì • ---
# â˜… VT API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”. (ë°œí‘œ ì§ì „ ìµœì¢… í™•ì¸ í•„ìˆ˜)
VT_API_KEY = "22f5fd2091e700b5013fc6b33a57af37a0fb2c1ddec13cc2ce870a14a0b5ac8e" 
# â˜…â˜…â˜… ì˜¤ë¥˜ ìˆ˜ì • ì™„ë£Œ: í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ì‹  ì‹¤ì œ íŒŒì¼ ê²½ë¡œ â˜…â˜…â˜…
TARGET_APK_PATH = "C:\\Users\\user\\Downloads\\AdhlCQtRVZYDTE8BXDza\\apk\\pgsHZz_decrypted.apk"

# -----------------------------------------------------

# --- 2. í—¬í¼ í•¨ìˆ˜ ---

def format_timestamp(value: Union[int, datetime, None]):
    """VTê°€ ë°˜í™˜í•œ ê°’(timestamp ë˜ëŠ” datetime)ì„ KSTë¡œ ë³€í™˜í•©ë‹ˆë‹¤."""
    if value is None: return "ì •ë³´ ì—†ìŒ"
    try:
        if isinstance(value, int): dt_object = datetime.fromtimestamp(value, timezone.utc)
        elif isinstance(value, datetime): dt_object = value
        else: return "ì•Œ ìˆ˜ ì—†ëŠ” ë‚ ì§œ í˜•ì‹"
        if dt_object.tzinfo is None: dt_object = dt_object.replace(tzinfo=timezone.utc)
        kst_offset = timedelta(hours=9)
        dt_kst = dt_object.astimezone(timezone(kst_offset))
        return dt_kst.strftime('%Y-%m-%d %H:%M:%S KST')
    except Exception: return "ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜"

def get_file_hash(filepath):
    """íŒŒì¼ì˜ SHA-256 í•´ì‹œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤."""
    sha256_hash = hashlib.sha256()
    with open(filepath, "rb") as f:
        for byte_block in iter(lambda: f.read(4096), b""): sha256_hash.update(byte_block)
    return sha256_hash.hexdigest()


def analyze_threat_label(label: str):
    """VTì˜ ë¶„ë¥˜ëª…(ì˜ˆ: trojan.bankbot/fakecop)ì„ ë¶„ì„í•˜ì—¬ ìœ í˜•, í–‰ìœ„, ê³„ì—´ë¡œ ë¶„í•´í•©ë‹ˆë‹¤."""
    analysis = {"type": "ê¸°íƒ€ (ì •ë³´ ì—†ìŒ)", "behavior": "ê¸°íƒ€ (ì •ë³´ ì—†ìŒ)", "family": "ì •ë³´ ì—†ìŒ"}
    
    TYPE_MAP = {'trojan': 'Trojan (ìì‹ ì„ ìœ ìš©í•œ ì•±ìœ¼ë¡œ ìœ„ì¥í•´ ì¹¨íˆ¬)', 'spyware': 'Spyware (ì‚¬ìš©ì ì •ë³´ë¥¼ ëª°ë˜ ìˆ˜ì§‘)'}
    BEHAVIOR_MAP = {'bankbot': 'BankBot (ê¸ˆìœµ/ë±…í‚¹ ì •ë³´ íƒˆì·¨ ì‹œë„)', 'banker': 'Banker (ê¸ˆìœµ/ë±…í‚¹ ì •ë³´ íƒˆì·¨ ì‹œë„)', 'stealer': 'InfoStealer (ê³„ì •/ê°œì¸ ì •ë³´ íƒˆì·¨)'}
    lower_label = label.lower()
    
    for keyword, description in TYPE_MAP.items():
        if keyword in lower_label: analysis["type"] = description; break
    for keyword, description in BEHAVIOR_MAP.items():
        if keyword in lower_label: analysis["behavior"] = description; break
            
    if '/' in label: analysis["family"] = f"{label.split('/')[-1].capitalize()} (ê³„ì—´)"
    elif '.' in label and len(label.split('.')) > 1: analysis["family"] = f"{label.split('.')[1].capitalize()} (ê³„ì—´)"
    if 'fakecop' in lower_label: analysis["family"] = "FakeCop (í˜ì´ì½¥ ê³„ì—´ ë³€ì¢…)"

    return analysis


# --- 3. ì‹¤ì œ VT ë¶„ì„ ë¡œì§ í•¨ìˆ˜ ---
def run_vt_report(target_apk_path: str = TARGET_APK_PATH, api_key: str = VT_API_KEY):
    # 0. íŒŒì¼ ê²½ë¡œ í™•ì¸
    if not os.path.exists(target_apk_path):
        print(f"[ì¹˜ëª…ì  ì˜¤ë¥˜] ëŒ€ìƒ íŒŒì¼({target_apk_path})ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    # VirusTotal API ë¶„ì„ (ì¦‰ì‹œ ì¡°íšŒ)
    print("\n--- 1. VirusTotal API ë¶„ì„ ë° ì¸í…”ë¦¬ì „ìŠ¤ ìˆ˜ì§‘ ---")
    client = vt.Client(api_key)
    file_hash = get_file_hash(target_apk_path)
    print(f"  [ëŒ€ìƒ í•´ì‹œ]: {file_hash}")
    
    file_report = None
    
    # 1-1. í˜„ì¬ ë¦¬í¬íŠ¸ ìƒíƒœ í™•ì¸ (API í‚¤ ë° ê¸°ë³¸ ë¡œë“œ)
    try:
        file_report = client.get_object(f"/files/{file_hash}")
        print(f"  [ì¡°íšŒ]: ì™„ë£Œëœ ìµœì‹  ë¦¬í¬íŠ¸ë¥¼ ì¦‰ì‹œ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.")
        
    except vt.error.APIError as e:
        error_code = e.code if hasattr(e, 'code') else 'UnknownError'
        
        if error_code == "AuthenticationRequired" or e.message == "Wrong API key":
            print("\n  [ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜] ì¸ì¦ ì‹¤íŒ¨! VT API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
            print("  - **ì›ì¸**: 'VT_API_KEY'ê°€ í‹€ë ¸ê±°ë‚˜, í‚¤ ì•ë’¤ì— ê³µë°± ë“±ì˜ ë¬¸ìê°€ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        elif error_code == "QuotaExceededError":
            print("\n  [ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜] í• ë‹¹ëŸ‰ ì´ˆê³¼! ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")
        elif error_code == "NotFoundError":
            print("  [ì¡°íšŒ]: ê¸°ì¡´ ë¦¬í¬íŠ¸ ì—†ìŒ. íŒŒì¼ì„ VTì— ì œì¶œí•©ë‹ˆë‹¤. 10ë¶„ í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
            with open(target_apk_path, "rb") as f: client.scan_file(f, f.name)
        else:
            print(f"\n  [ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜] ê¸°íƒ€ API ì˜¤ë¥˜ ë°œìƒ! ì½”ë“œ: {error_code}, ë©”ì‹œì§€: {e.message}")
        
        client.close()
        return
    except Exception as e:
        print(f"  [ê¸°íƒ€ ì˜¤ë¥˜] í”„ë¡œê·¸ë¨ ì¤‘ë‹¨: {e}")
        client.close()
        return

    # --- 3. VT ë¦¬í¬íŠ¸ ìƒì„¸ ì¶œë ¥  ---
    print("\n" + "="*50)
    print("      ğŸ‘‘ VirusTotal ìƒì„¸ ì¸í…”ë¦¬ì „ìŠ¤ ë³´ê³ ì„œ (ìµœì¢…) ğŸ‘‘")
    print("="*50)
    
    # [A] ê¸°ë³¸ íŒŒì¼ ì •ë³´
    print("\n[A] ê¸°ë³¸ íŒŒì¼ ì •ë³´ (Basic properties)")
    print(f"  - MD5: {file_report.get('md5', 'ì •ë³´ ì—†ìŒ')}")
    print(f"  - SHA-256: {file_report.sha256}")
    print(f"  - íŒŒì¼ í¬ê¸°: {file_report.size / (1024*1024):.2f} MB ({file_report.size} bytes)")
    
    # [B] ìœ„í—˜ë„ ë° ë¶„ë¥˜ (ìƒì„¸ ë¶„ì„)
    print("\n[B] ìœ„í—˜ë„ ë° ë¶„ë¥˜ (Detection)")
    stats = file_report.last_analysis_stats
    detected_count = stats.get('malicious', 0) + stats.get('suspicious', 0)
    total_count = stats.get('harmless', 0) + detected_count + stats.get('undetected', 0)
    print(f"  - ì•…ì„±ì½”ë“œ íƒì§€ ìˆ˜ (ë¹¨ê°„ë¶ˆ): {detected_count} / {total_count}ê°œ")
    
    threat_label = file_report.get('popular_threat_classification', {}).get('suggested_threat_label', 'ì •ë³´ ì—†ìŒ')
    print(f"\n  - **ëŒ€í‘œ ë¶„ë¥˜ëª… (Raw)**: {threat_label}")
    
    if threat_label != "ì •ë³´ ì—†ìŒ":
        analysis = analyze_threat_label(threat_label)
        print(f"  - **[ë¶„ì„] ì•…ì„±ì½”ë“œ ìœ í˜• (Type)**: {analysis['type']}")
        print(f"  - **[ë¶„ì„] ì£¼ìš” í–‰ìœ„ (Behavior)**: {analysis['behavior']}")
        print(f"  - **[ë¶„ì„] ì•…ì„±ì½”ë“œ ê³„ì—´ (Family)**: {analysis['family']}")
    
    
    # [F] ê°œë³„ ë°±ì‹  íƒì§€ ê²°ê³¼ (ì „ì²´ ì¶œë ¥)
    print("\n[F] ê°œë³„ ë°±ì‹  íƒì§€ ê²°ê³¼")
    results = file_report.get('last_analysis_results', {})
    
    if results:
        malicious_results = []
        for vendor_name, result_data in results.items():
            category = result_data.get('category')
            if category in ['malicious', 'suspicious']:
                malicious_results.append(f"  > {vendor_name}: {result_data.get('result', 'N/A')}")
        
        if malicious_results:
            print(f"\n  --- ì•…ì„±ìœ¼ë¡œ ë¶„ë¥˜í•œ ê°œë³„ ë²¤ë” ëª©ë¡ ({len(malicious_results)}ê°œ) ---")
            for res in malicious_results:
                print(res)
        else:
            print("  - ê°œë³„ ë²¤ë” ëª©ë¡ ì¶œë ¥ ë¶ˆê°€ (ëª¨ë‘ clean/undetected)")
            
    
    # [C] íŒŒì¼ íˆìŠ¤í† ë¦¬
    print("\n[C] íŒŒì¼ íˆìŠ¤í† ë¦¬")
    print(f"  - VT ìµœì´ˆ ì œì¶œ ì‹œê°: {format_timestamp(file_report.get('first_submission_date'))}")
    print(f"  - VT ë§ˆì§€ë§‰ ë¶„ì„ ì‹œê°: {format_timestamp(file_report.get('last_analysis_date'))}")
    
    # [D, J, K] ì„¹ì…˜ì€ íŒ€ì¥ë‹˜ ìš”ì²­ì— ë”°ë¼ ì¶œë ¥ì—ì„œ ì œì™¸ë¨
    
    print("\n" + "="*50)
    print("                ë³´ê³ ì„œ ìë™ ìƒì„± ì™„ë£Œ")
    print("="*50)

    client.close()


def main():
    run_vt_report()


if __name__ == "__main__":
    main()
